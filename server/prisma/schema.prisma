generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   Int            @id @default(autoincrement())
  email                String         @unique
  password             String?
  name                 String?
  avatarUrl            String?
  googleId             String?
  role                 Role           @default(USER)
  resetPasswordToken   String?
  resetPasswordExpires DateTime?
  createdAt            DateTime       @default(now())
  
  // Relations
  notes                Note[]
  notifications        Notification[]
  
  // New: Gamification & Forum Relations
  progress             UserProgress?
  challengeProgress    ChallengeProgress[]
  forumThreads         ForumThread[]
  forumPosts           ForumPost[]
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  message   String
  isRead    Boolean  @default(false)
  type      String   @default("INFO")
  link      String?
  imageUrl  String?  // Add this new field
  createdAt DateTime @default(now())
}

enum Role {
  USER
  ADMIN
}

enum CourseType {
  UNIVERSITY
  LEARN
}

model Course {
  id       String     @id
  name     String
  // [ADD THIS] Type field with a default
  type     CourseType @default(UNIVERSITY)
  branches Branch[]
  units    Unit[]
}

model Branch {
  id       String   @id // REMOVED @default(cuid())
  name     String
  course   Course   @relation(fields: [courseId], references: [id])
  courseId String
  subjects Subject[]
}

model Semester {
  id       String   @id // REMOVED @default(cuid())
  name     String
  subjects Subject[]
}

model Subject {
  id         String   @id // REMOVED @default(cuid())
  name       String
  branch     Branch   @relation(fields: [branchId], references: [id])
  branchId   String
  semester   Semester @relation(fields: [semesterId], references: [id])
  semesterId String
  topics     Topic[]

  @@unique([branchId, semesterId, name])
}

model Topic {
  id        String   @id @default(cuid()) // Topics can still be auto-generated
  name      String
  subject   Subject  @relation(fields: [subjectId], references: [id])
  subjectId String
  notes     Note[]
}

model Note {
  id         Int      @id @default(autoincrement())
  title      String
  pdfUrl     String   
  topic      Topic    @relation(fields: [topicId], references: [id])
  topicId    String
  uploader   User     @relation(fields: [uploaderId], references: [id])
  uploaderId Int
  createdAt  DateTime @default(now())
}

model UserProgress {
  id             Int      @id @default(autoincrement())
  userId         Int      @unique
  user           User     @relation(fields: [userId], references: [id])
  hearts         Int      @default(5)
  points         Int      @default(0)
  activeCourseId String?
  
  // [ADD THIS] Track when the last refill happened or hearts were full
  lastRefillAt   DateTime @default(now()) 
}

model Unit {
  id          Int       @id @default(autoincrement())
  title       String
  description String
  order       Int
  courseId    String    // Links to StudyFlow's existing Course ID
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]
}

model Lesson {
  id         Int         @id @default(autoincrement())
  title      String
  order      Int
  unitId     Int
  unit       Unit        @relation(fields: [unitId], references: [id], onDelete: Cascade)
  challenges Challenge[]
}

enum ChallengeType {
  SELECT
  ASSIST
}

model Challenge {
  id                Int                 @id @default(autoincrement())
  lessonId          Int
  lesson            Lesson              @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  type              ChallengeType
  question          String
  order             Int
  options           ChallengeOption[]
  challengeProgress ChallengeProgress[]
}

model ChallengeOption {
  id          Int       @id @default(autoincrement())
  challengeId Int
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  text        String
  correct     Boolean
  imageSrc    String?
  audioSrc    String?
}

model ChallengeProgress {
  id          Int       @id @default(autoincrement())
  userId      Int
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  challengeId Int
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  completed   Boolean   @default(false)

  @@unique([userId, challengeId])
}

// --- NEW FORUM MODELS ---

model ForumThread {
  id             Int         @id @default(autoincrement())
  title          String
  body           String      @db.Text
  authorId       Int
  author         User        @relation(fields: [authorId], references: [id])
  views          Int         @default(0)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  posts          ForumPost[]
}

model ForumPost {
  id           Int         @id @default(autoincrement())
  body         String      @db.Text
  threadId     Int
  thread       ForumThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  authorId     Int
  author       User        @relation(fields: [authorId], references: [id])
  parentId     Int?        // For nested replies
  parent       ForumPost?  @relation("PostReplies", fields: [parentId], references: [id])
  replies      ForumPost[] @relation("PostReplies")
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}